<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debby Expense Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    // Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, getDocs, deleteDoc, doc 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { 
      getAuth, signInAnonymously, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBG42OrS2R0lt17SKfwKaTgycMsk_ssqNI",
      authDomain: "debby-expense-tracker-app.firebaseapp.com",
      projectId: "debby-expense-tracker-app",
      storageBucket: "debby-expense-tracker-app.firebasestorage.app",
      messagingSenderId: "527529857701",
      appId: "1:527529857701:web:f01646b2afb442438d334c",
      measurementId: "G-CJEE12XD97"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let userId = null;

    const expenseForm = document.getElementById("expense-form");
    const expensesList = document.getElementById("expenses-list");
    const totalEl = document.getElementById("total");
    const errorBox = document.getElementById("error-box");

    // Show error messages visibly
    function showError(msg) {
      errorBox.innerText = "‚ö†Ô∏è " + msg;
      errorBox.classList.remove("hidden");
      setTimeout(() => errorBox.classList.add("hidden"), 5000);
    }

    // Fetch & render expenses
    async function renderExpenses() {
      expensesList.innerHTML = "";
      let total = 0;
      try {
        const snapshot = await getDocs(collection(db, "users", userId, "expenses"));
        snapshot.forEach((docSnap) => {
          const exp = docSnap.data();
          total += Number(exp.amount);
          const li = document.createElement("li");
          li.className = "flex justify-between bg-white shadow rounded p-3 mb-2";
          li.innerHTML = `
            <span><strong>${exp.name}</strong> (${exp.category}) - ‚Ç¶${exp.amount} on ${exp.date}</span>
            <button class="text-red-600" data-id="${docSnap.id}">‚ùå</button>
          `;
          expensesList.appendChild(li);
        });
        totalEl.innerText = "‚Ç¶" + total;
      } catch (e) {
        showError("Failed to fetch expenses: " + e.message);
      }
    }

    // Add expense
    expenseForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = expenseForm.name.value.trim();
      const amount = parseFloat(expenseForm.amount.value);
      const category = expenseForm.category.value;
      const date = expenseForm.date.value;

      if (!name || !amount || !date) {
        showError("All fields are required!");
        return;
      }

      try {
        await addDoc(collection(db, "users", userId, "expenses"), {
          name, amount, category, date
        });
        expenseForm.reset();
        renderExpenses();
      } catch (e) {
        showError("Failed to add expense: " + e.message);
      }
    });

    // Delete expense
    expensesList.addEventListener("click", async (e) => {
      if (e.target.tagName === "BUTTON") {
        const id = e.target.dataset.id;
        try {
          await deleteDoc(doc(db, "users", userId, "expenses", id));
          renderExpenses();
        } catch (e) {
          showError("Failed to delete expense: " + e.message);
        }
      }
    });

    // Auth
    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        renderExpenses();
      } else {
        signInAnonymously(auth).catch((e) => {
          showError("Auth failed: " + e.message);
        });
      }
    });
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg">
    <h1 class="text-2xl font-bold mb-4 text-center">üí∞ Debby Expense Tracker</h1>

    <!-- Error box -->
    <div id="error-box" class="hidden bg-red-100 text-red-700 p-2 mb-4 rounded"></div>

    <!-- Form -->
    <form id="expense-form" class="space-y-3">
      <input type="text" name="name" placeholder="Expense name" class="w-full border p-2 rounded" />
      <input type="number" name="amount" placeholder="Amount" class="w-full border p-2 rounded" />
      <input type="date" name="date" class="w-full border p-2 rounded" />
      <select name="category" class="w-full border p-2 rounded">
        <option value="Food">Food</option>
        <option value="Transport">Transport</option>
        <option value="Bills">Bills</option>
        <option value="Other">Other</option>
      </select>
      <button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Add Expense</button>
    </form>

    <!-- Expense list -->
    <ul id="expenses-list" class="mt-4"></ul>

    <!-- Total -->
    <div class="mt-4 text-xl font-semibold text-right">Total: <span id="total">‚Ç¶0</span></div>
  </div>
</body>
</html>
