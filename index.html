<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Debby Expense Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, setDoc 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ğŸ”‘ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBG42OrS2R0lt17SKfwKaTgycMsk_ssqNI",
      authDomain: "debby-expense-tracker-app.firebaseapp.com",
      projectId: "debby-expense-tracker-app",
      storageBucket: "debby-expense-tracker-app.firebasestorage.app",
      messagingSenderId: "527529857701",
      appId: "1:527529857701:web:f01646b2afb442438d334c",
      measurementId: "G-CJEE12XD97"
    };

    // ğŸ”¥ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM elements
    const expenseForm = document.getElementById("expenseForm");
    const myExpensesList = document.getElementById("myExpensesList");
    const allExpensesList = document.getElementById("allExpensesList");
    const nameForm = document.getElementById("nameForm");
    const userNameSpan = document.getElementById("userName");
    const userIdSpan = document.getElementById("userId");

    let userId = null;
    let userDocRef = null;
    let myExpensesCollectionRef = null;
    const allExpensesCollectionRef = collection(db, "expenses"); // ğŸŒ General expenses

    // âœ… Load general (public) expenses
    function loadAllExpenses() {
      onSnapshot(allExpensesCollectionRef, (snapshot) => {
        allExpensesList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const li = document.createElement("li");
          li.className = "flex justify-between items-center p-2 border rounded mb-2";
          li.innerHTML = `
            <span>${data.date} - ${data.category} (${data.description || "No description"}) : â‚¦${data.amount} by ${data.userName || "Anonymous"}</span>
          `;
          allExpensesList.appendChild(li);
        });
      });
    }

    // âœ… Load personal expenses
    function loadMyExpenses() {
      onSnapshot(myExpensesCollectionRef, (snapshot) => {
        myExpensesList.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          const li = document.createElement("li");
          li.className = "flex justify-between items-center p-2 border rounded mb-2";
          li.innerHTML = `
            <span>${data.date} - ${data.category} (${data.description || "No description"}) : â‚¦${data.amount}</span>
            <button class="bg-red-500 text-white px-2 py-1 rounded delete-btn" data-id="${docSnap.id}">Delete</button>
          `;
          myExpensesList.appendChild(li);
        });

        // attach delete event
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            await deleteDoc(doc(db, "users", userId, "expenses", id));
            await deleteDoc(doc(db, "expenses", id)); // also remove from general
          });
        });
      });
    }

    // âœ… Auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        userIdSpan.textContent = userId.substring(0, 8) + "...";

        userDocRef = doc(db, "users", userId);
        myExpensesCollectionRef = collection(db, "users", userId, "expenses");

        // Load profile name
        onSnapshot(userDocRef, (docSnap) => {
          if (docSnap.exists()) {
            const data = docSnap.data();
            userNameSpan.textContent = data.displayName || "Anonymous";
          } else {
            userNameSpan.textContent = "Anonymous";
          }
        });

        loadMyExpenses();
        loadAllExpenses();
      } else {
        await signInAnonymously(auth);
      }
    });

    // âœ… Add expense
    expenseForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const amount = document.getElementById("amount").value;
      const category = document.getElementById("category").value;
      const description = document.getElementById("description").value;
      const date = document.getElementById("date").value;

      if (!amount || !category || !date) return alert("All fields required!");

      const expenseData = {
        amount: Number(amount),
        category,
        description,
        date,
        userId,
        userName: userNameSpan.textContent
      };

      // Save in both userâ€™s collection + general collection
      const newExpenseRef = await addDoc(myExpensesCollectionRef, expenseData);
      await setDoc(doc(db, "expenses", newExpenseRef.id), expenseData);

      expenseForm.reset();
    });

    // âœ… Update profile name
    nameForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const displayName = document.getElementById("displayName").value;
      if (!displayName) return alert("Enter a name");

      await setDoc(userDocRef, { displayName }, { merge: true });
      userNameSpan.textContent = displayName;
      nameForm.reset();
    });
  </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-3xl bg-white p-6 rounded-xl shadow-lg">
    <h1 class="text-2xl font-bold mb-4 text-center">ğŸ’° Debby Expense Tracker</h1>

    <!-- User Profile -->
    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
      <p><strong>User:</strong> <span id="userName">Loading...</span></p>
      <p class="text-sm text-gray-500">ID: <span id="userId"></span></p>
    </div>

    <!-- Update Name -->
    <form id="nameForm" class="flex gap-2 mb-4">
      <input id="displayName" type="text" placeholder="Enter your name" class="flex-1 border p-2 rounded">
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button>
    </form>

    <!-- Add Expense -->
    <form id="expenseForm" class="grid gap-2 mb-6">
      <input id="amount" type="number" placeholder="Amount (â‚¦)" class="border p-2 rounded">
      <input id="category" type="text" placeholder="Category" class="border p-2 rounded">
      <input id="description" type="text" placeholder="Description (optional)" class="border p-2 rounded">
      <input id="date" type="date" class="border p-2 rounded">
      <button type="submit" class="bg-green-500 text-white py-2 rounded">Add Expense</button>
    </form>

    <!-- My Expenses -->
    <h2 class="text-lg font-semibold mb-2">ğŸ“Œ My Expenses</h2>
    <ul id="myExpensesList" class="space-y-2 mb-6"></ul>

    <!-- All Expenses -->
    <h2 class="text-lg font-semibold mb-2">ğŸŒ All Expenses</h2>
    <ul id="allExpensesList" class="space-y-2"></ul>
  </div>
</body>
</html>
